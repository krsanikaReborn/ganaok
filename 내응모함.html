<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.7.10/vue.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.css" />
<script src="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.js"></script>

<!-- <script src="https://cdn.jsdelivr.net/npm/vue-awesome-swiper@5.0.1/index.min.js"></script> -->

<style>
    .txt_01 {
        font-size: 14px;
        font-weight: 500;
        line-height: 16.8px;
        text-align: left;
        width: 110px;
        margin: auto;
        text-overflow: ellipsis;
        white-space: nowrap;
        overflow: hidden;
    }

    .txt_02 {
        font-size: 10px;
        font-weight: 500;
        line-height: 15px;
        text-align: left;
        width: 110px;
        margin: auto;
        text-overflow: ellipsis;
        white-space: nowrap;
        overflow: hidden;
    }

    .txt_04 {
        font-size: 14px;
        font-weight: 500;
        line-height: 16.8px;
        text-align: left;
        width: 90px;
        margin: auto;
        text-overflow: ellipsis;
        min-height: 50px;
        white-space: nowrap;
        overflow: hidden;
    }

    .txt_05 {
        font-size: 10px;
        font-weight: 500;
        line-height: 15px;
        text-align: left;
        width: 90px;
        margin: auto;
        text-overflow: ellipsis;
        min-height: 30px;
        white-space: nowrap;
        overflow: hidden;
    }

    .bc_F9F9F9 {
        background: #F9F9F9;
    }

    .login_btn {
        background: #333333;
        color: #fff;
        font-size: 16px;
        font-weight: 500;
        padding: 16px;
        width: 100%;
        margin: 0 0 12px 0;
    }

    .p_30 {
        padding: 30px 12px 16px;
    }

    .swiper {
        width: 100%;
        height: 100%;
    }

    .swiper-slide {
        text-align: center;
        font-size: 18px;
        background: #fff;
        /* Center slide text vertically */
        display: -webkit-box;
        display: -ms-flexbox;
        display: -webkit-flex;
        display: flex;
        -webkit-box-pack: center;
        -ms-flex-pack: center;
        -webkit-justify-content: center;
        justify-content: center;
        -webkit-box-align: center;
        -ms-flex-align: center;
        -webkit-align-items: center;
        align-items: center;
    }

    .swiper-slide img {
        display: block;
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .mySwiper .swiper-slide-prev,
    .mySwiper .swiper-slide-next {
        width: 80%;
        height: 80%;
    }

    .mySwiper {
        width: 650px;
        margin-left: -145px;
    }

    .mySwiper2 .swiper-slide img {
        width: 110px;
    }

    .swiper-pagination {
        margin-bottom: -36px;
    }

    .swiper-pagination-bullet-active {
        top: 1px;
        background: #050402 !important;
        width: 8px !important;
        height: 8px !important;
        position: relative;
    }

    .swiper-pagination-bullet {
        width: var(--swiper-pagination-bullet-width, var(--swiper-pagination-bullet-size, 6px));
        height: var(--swiper-pagination-bullet-height, var(--swiper-pagination-bullet-size, 6px));
        background: #999999;
        opacity: 1;
    }

    .swiper-horizontal>.swiper-pagination-bullets .swiper-pagination-bullet,
    .swiper-pagination-horizontal.swiper-pagination-bullets .swiper-pagination-bullet {
        margin: 0 var(--swiper-pagination-bullet-horizontal-gap, 2px);
    }


    .img_txt {
        position: fixed;
        color: #fff;
        /* padding-top: 190px; */
        bottom: 40px;
        padding-right: 150px;
        text-align: left;
    }

    .img_txt02 {
        text-align: left;
        background: #EE5529;
        width: 60px;
        font-size: 10px;
        padding: 2px;
    }

    .img_txt03 {
        font-size: 22px;
        font-weight: 700;
    }

    .img_txt04 {
        font-size: 14px;
        font-weight: 500;
    }

    .pd_60_20_14 {
        padding: 60px 20px 14px;
    }

    .pd_0_20_32 {
        padding: 0px 20px 32px;
    }

    .pd_0_20 {
        padding: 0 20px;
    }

    .pd_24_20_14_5 {
        padding: 24px 20px 14px 5px;
    }


    .pl_5px {
        padding-left: 20px;
        padding-right: 20px;
    }

    .h_80 {
        height: 80px;
    }

    .pt_108 {
        padding-top: 108px;
    }

    .align_cen {
        align-items: center;
    }

    .cursor_p {
        cursor: pointer;
    }

    .align_end {
        align-items: end;
    }

    .header_ttl {
        color: #121212;
        font-weight: 500;
        font-size: 16px;
        line-height: 150%;
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
        width: 180px;
    }

    .pb_10 {
        padding-bottom: 10px;
    }

    .bl_boxCon {
        width: 100%;
        padding: 0 15px;
        margin: auto;
    }

    .bl_boxRow {
        display: flex;
        flex-wrap: wrap;
        margin-right: -15px;
        margin-left: -15px;
    }

    .bl_boxCol {
        flex-basis: 0;
        flex-grow: 1;
        max-width: 100%;
        padding-left: 15px;
        padding-right: 15px;
    }

    .hp_pSide_20 {
        padding-left: 20px;
        padding-right: 20px;
    }

    .hp_pSide_40 {
        padding-left: 40px;
        padding-right: 25px;
    }

    body {
        width: 360px;
        margin: auto;
    }

    .mb_24 {
        margin-bottom: 24px;
    }

    .maxH_335 {
        max-height: 335px;
    }

    .bl_date {
        position: fixed;
        color: #828282;
        padding-top: 340px;
        right: 0;
        font-weight: 500;
        font-size: 14px;
        opacity: 0.8;
    }

    .bl_flS {
        min-height: 360px;
        align-items: flex-start;
    }

    .bl_textId {
        font-size: 16px;
        font-weight: 700;
        line-height: 120%;
        color: #333;
        opacity: 0.8;
    }

    .bl_textSub {
        font-size: 14px;
        font-weight: 500;
        line-height: 120%;
        color: #828282;
    }

    .bl_bgf9 {
        background-color: #f9f9f9;
    }

    .bl_textArea {
        /* min-width: 335px; */
        width: 100%;
        min-height: 63px;
        height: auto;
        display: flex;
        align-items: center;
    }

    .bl_textCont {
        font-size: 14px;
        font-weight: 400;
        line-height: 150%;
        letter-spacing: 0.01em;
        color: #333;
        opacity: 0.8;
        padding: 0 12px;
        word-break: break-all;
    }

    .hp_pT14pB28 {
        padding-top: 14px;
        padding-bottom: 20px;
    }

    .bl_shareBtn{
        width: 100%;
        height: auto;
        min-height: 56px;
        text-align: center;
        background-color: #DDDDDD;
    }

    .bl_shareBtn .bl_btnText {
        font-weight: 700;
        font-size: 16px;
        line-height: 150%;
        color: #A7A7A7;
        letter-spacing: 0.04em;
        padding-left: 8px;
    }

    .bl_shareBtn.active{
        background-color: #121212 !important;
    }


    .bl_shareBtn.active .bl_btnText{
        color: #fff !important;
    }

    .hp_mb42{
        margin-bottom: 42px;
    }

    #raffle_swiper{
        padding : 20px;
    }

</style>

<div id="app">
    <template v-if="coupons.length > 0">
        <div class="container-fluid mx-0 px-0">
            <div class="row pb_32 mx-0 of_g">
                <div class="col fs_14 px-0">
                    <div id="raffle_swiper" class="swiper">
                        <div class="swiper-wrapper">
                            <template v-for="(item, index) in coupons">
                                <div :id="'coupon'+index" class="swiper-slide align-self-center bl_flS">
                                    <img :src=item.coupon_img alt="" class="img-fluid maxH_335">
                                    <div class="bl_date">{{ item.coupon_date }}</div>
                                </div>
                            </template>                        
                        </div>
                    </div>
                    <div class="swiper-pagination share_hide"></div>
                </div>
            </div>
        </div>
        <!-- textField -->
        <div class="hp_pSide_20">
            <span id="username" class="bl_textId"></span>
            <span class="bl_textSub">님의 추첨 응모권</span>
        </div>
        <!-- textContent -->
        <div class="hp_pSide_20 hp_pT14pB28">
            <div class="bl_textArea bl_bgf9">
                <div class="bl_textCont">아직 응모권을 획득하지 못했습니다.<br>가상 전시회에서 리워드를 획득해보세요.</div>
            </div>
        </div>
        <!-- shareBtn -->
        <div class="hp_pSide_20">
            <button id='shareBtn' class="bl_shareBtn hp_mb42 share_hide">
                <div class="">
                    <img src="https://ganaart.s3.ap-northeast-2.amazonaws.com/ic_Insta.svg" class="img-fluid">
                    <span class="bl_btnText">지금 바로 공유</span>
                </div>
            </button>
        </div>    
    </template>
    <template v-else>
        <div class="hp_pSide_20 hp_pT14pB28">
            <div class="bl_textArea bl_bgf9">
                <div class="bl_textCont">현재 공개된 응모권이 없습니다.</div>
            </div>
        </div>
    </template>


</div>


<script>

$(()=>{
    let app = new Vue({
    el : "#app",
    name : "app",
    data : {
        coupons : [], //.idContext=밑에 들어가야할 문구, idContext=응모권종류. 1.전시관 2.전체 전시회 3.공유
        couponType : [],
        swiper : null,
        context : [
            "아직 응모권을 획득하지 못했습니다.<br>가상 전시회에서 리워드를 획득해보세요.",
            "본 사용자는 가상전시회의 관람으로 응모권을 획득하셨습니다.",
            "본 사용자는 모든 가상 전시공간을 관람하여<br>추가 응모권을 획득하였습니다.",
            "본 사용자는 촬영한 작품을 공유하여 응모권을 획득하였습니다."
        ]
    },
    methods : {
        async getCoupons () {
            //전시관 귀속
            const pr1 = util.getFromApi('/app/mission.master.nx', {use_sub : "Y", form_yn : "Y", complete_yn : "Y", nx_SESS_ID : util.getSessionId(), pa : 1000});
            //기타 응모권(쿠폰)
            const pr2 = util.getFromApi('/app/coupon.list.nx', {type : "F", nx_SESS_ID : util.getSessionId()});

            $.when(pr1, pr2).done((r1,r2)=>{
                if(r1.items?.length > 0){
                    for(master of r1.items){
                        const now = new Date();
                        const sdate = new Date(master.form[0].exhibitionStart);
                        const edate = new Date(master.form[1].exhibitionEnd);
                        if(!(sdate < now && now < edate)){
                            continue;
                        }
                        for(sub of master.sub){
                            if(Object.keys(sub.complete).length > 0){
                                // //바마아트마켓 대응 하드코딩
                                // if(/59|60|61/i.test(sub?.ms_item[0].idx)){
                                //     continue;
                                // }                     
                                sub.complete.idType = 1;       
                                sub.complete.idContext = sub.complete.coupon_yn == 'Y' ? 1:0;                                
                                this.coupons.push(sub.complete);
                            }
                        }
                        if(Object.keys(master.complete).length > 0){
                            sub.complete.idType = 2;
                            master.complete.idContext = master.complete.coupon_yn == 'Y' ? 2:0;
                            this.coupons.push(master.complete);
                        }
                    }
                }
//              console.log(r2);
                if(r2.items?.length > 0){
                    for(item of r2.items){
                        var found = this.coupons.find(e=>e.coupon_img == item.auto_coupon_img)
                        if(!found){
                            this.coupons.push({
                                coupon_date : item.coupon_date,
                                coupon_img : item.coupon_img != "" ? item.coupon_img : item.auto_coupon_img,
                                coupon_yn : "Y",
                                idType : 3,
                                idContext : 3,
                                isActive : "Y",
                                result : "Y"
                            });
                        }
                    }
                }

            });
        },


        async init () {
            //여기서 처음켠 웹뷰면 참여안내처럼 돌아가기.
            if(window.history.length < 2){
                $('#icon_back').click(()=>{
                    vu.send('entryinfo', 10006, '');
                })
            }
            $('#header').addClass('share_hide');
            this.swiper = new Swiper("#raffle_swiper", {
                slidesPerView: 1,
                centeredSlides: true,
                spaceBetween: 30,
                grabCursor: true,
                pagination: {
                    el: ".swiper-pagination",
                    clickable: true,
                },
                on : {
                    activeIndexChange : ()=>{
                        let coupon = app.coupons[app.swiper.realIndex];
                        app.drawActive(coupon.coupon_yn, coupon.idContext);
                    }
                }
            });

            this.drawUserName();
            
            if(this.coupons.length > 0){
                this.drawActive(this.coupons[0].coupon_yn, this.coupons[0].idContext);
            }
        },

        drawActive (isActive, idContext) {
            $('#shareBtn').removeClass('active').off('click');
            if(isActive == 'Y'){                
                $('#shareBtn').addClass('active').on('click', this.share);
            }
            $('.bl_textCont').html(this.context[idContext]);


        },
        
        share (){
            $('.share_hide').hide();
            //1초뒤 버튼복귀
            setTimeout(()=>{
                $('.share_hide').show();
            }, 1000)
            result = user.toShare();
        },
        drawUserName (){
            let name = util.getCookie('name');
            if(name != 'undefined'){
                $('#username').html(name);
            }else{
                $('#username').next().html('추첨 응모권');
            }
        }

    },

    filters : {
        replaceCouponImg : (item)=>{
            return item.coupon_img != '' ? item.coupon_img : item.img; 
        }
    },

    async mounted () {
        await this.$nextTick();
        await this.getCoupons();
        setTimeout(this.init, 300);
    },
    
});


});







</script>